<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f8f9fb; --fg:#111; --muted:#666; --card:#fff; --line:#eaecef; --ok:#12a150; --bad:#c13232; --warn:#c47a00;
      --pill:#eef1f5;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--fg)}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid var(--line); background:var(--card); position:sticky; top:0; z-index:10}
    header h2{margin:0; font-weight:700}
    .container{max-width:1100px; margin:20px auto; padding:0 16px}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px}
    .span-12{grid-column:span 12}
    .span-8{grid-column:span 8}
    .span-6{grid-column:span 6}
    .span-4{grid-column:span 4}
    .span-3{grid-column:span 3}
    @media (max-width:1024px){ .span-8,.span-6,.span-4,.span-3{grid-column:span 12} }
    h3{margin:6px 0 12px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, textarea, button{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#fff; color:var(--fg)}
    textarea{min-height:92px; resize:vertical}
    button{border:0; background:#111; color:#fff; cursor:pointer}
    button.ghost{background:transparent; color:#111; border:1px solid var(--line)}
    button:disabled{opacity:.6; cursor:not-allowed}
    .row{display:flex; gap:10px; align-items:center}
    .list{max-height:280px; overflow:auto; border:1px solid var(--line); border-radius:10px}
    .item{padding:10px 12px; border-bottom:1px solid var(--line); cursor:pointer}
    .item:hover{background:#fafafa}
    .mono{font-family:ui-monospace,Menlo,monospace}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:var(--pill); font-size:12px; color:#222}
    .pill.ok{background:#e7f6ee; color:var(--ok)}
    .pill.bad{background:#fdeaea; color:var(--bad)}
    .pill.warn{background:#fff3e0; color:var(--warn)}
    img.qr{max-width:280px; border:1px solid var(--line); border-radius:8px; display:block}
    .muted{color:var(--muted); font-size:12px}
    .kvs{display:grid; grid-template-columns:110px 1fr; gap:6px 10px; align-items:center}
    .right{margin-left:auto}
    .nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .toast{position:fixed; right:16px; bottom:16px; background:#111; color:#fff; padding:10px 12px; border-radius:10px; opacity:0; transform:translateY(8px); transition:.2s}
    .toast.show{opacity:1; transform:translateY(0)}
  </style>
</head>
<body>
  <header>
    <h2>Admin Panel</h2>
    <div class="row">
      <span id="statusPill" class="pill">Durum: baÄŸlanÄ±yorâ€¦</span>
      <button class="ghost" id="logoutBtn" title="Ã‡Ä±kÄ±ÅŸ">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Oturum Listesi -->
      <div class="card span-8">
        <div class="row" style="justify-content:space-between; margin-bottom:8px">
          <h3>Oturumlar</h3>
          <div class="row">
            <button class="ghost" id="refreshBtn">Yenile</button>
          </div>
        </div>
        <div id="sessionList" class="list"></div>
        <div class="muted" style="margin-top:8px">Bir oturuma tÄ±klayÄ±nca alt bÃ¶lÃ¼mde detaylarÄ± ve QRâ€™yi gÃ¶rÃ¼rsÃ¼n.</div>
      </div>

      <!-- Yeni Oturum -->
      <div class="card span-4">
        <h3>Yeni Oturum OluÅŸtur</h3>
        <label>Ä°sim (opsiyonel)</label>
        <input id="newName" placeholder="Ã–rn: Destek HattÄ±">
        <button id="createBtn">OluÅŸtur & AnahtarlarÄ± Ãœret</button>
        <div id="createResp" class="muted" style="margin-top:8px"></div>
      </div>

      <!-- SeÃ§ili Oturum -->
      <div class="card span-6">
        <h3>SeÃ§ili Oturum</h3>
        <div id="selectedNone" class="muted">Listeden bir oturum seÃ§.</div>
        <div id="selected" style="display:none">
          <div class="kvs">
            <div class="muted">Session ID</div><div class="row"><span id="s_id" class="mono nowrap"></span><button class="ghost right" data-copy="#s_id">Kopyala</button></div>
            <div class="muted">Ad</div><div id="s_name"></div>
            <div class="muted">Durum</div><div id="s_status"></div>
            <div class="muted">API Key</div><div class="row"><span id="s_api" class="mono nowrap"></span><button class="ghost right" data-copy="#s_api">Kopyala</button></div>
            <div class="muted">Webhook Secret</div><div class="row"><span id="s_secret" class="mono nowrap"></span><button class="ghost right" data-copy="#s_secret">Kopyala</button></div>
          </div>

          <div style="margin-top:12px">
            <h4>cURL Ã–rneÄŸi (Bearer ile, sessionId olmadan)</h4>
            <pre id="s_curl" class="mono" style="white-space:pre-wrap; background:#f7f7f9; padding:10px; border-radius:8px; border:1px solid var(--line)"></pre>
            <button class="ghost right" data-copy="#s_curl">cURL Kopyala</button>
          </div>

          <div style="margin-top:12px">
            <h4>QR / BaÄŸlantÄ±</h4>
            <div id="qrBox" class="row" style="gap:12px; align-items:flex-start"></div>
            <div class="row" style="gap:8px; margin-top:8px">
              <button class="ghost" id="showQRBtn">QR Yenile / GÃ¶ster</button>
              <span class="muted">WhatsApp â†’ BaÄŸlÄ± Cihazlar ile tara.</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Webhook + Test -->
      <div class="card span-6">
        <h3>Webhook ve Test</h3>
        <label>Webhook URL</label>
        <input id="w_url" placeholder="https://.../incoming">
        <div class="row" style="gap:8px">
          <button id="saveWebhookBtn">Webhook Kaydet</button>
          <button class="ghost" id="pingWebhookBtn">Webhook Test (Ã¶rnek POST)</button>
        </div>
        <div id="webhookResp" class="muted" style="margin-top:6px"></div>

        <hr style="border:none;border-top:1px solid var(--line); margin:16px 0" />

        <h4>Metin GÃ¶nder</h4>
        <label>AlÄ±cÄ± (905xxxxxxxxx veya chatId)</label>
        <input id="toText" placeholder="9053XXXXXXX">
        <label>Mesaj</label>
        <textarea id="msgText">Merhaba ðŸ‘‹</textarea>
        <button id="sendTextBtn">GÃ¶nder</button>
        <div id="sendTextResp" class="muted" style="margin-top:6px"></div>

        <h4 style="margin-top:18px">Medya GÃ¶nder</h4>
        <label>AlÄ±cÄ±</label><input id="toMedia" placeholder="9053XXXXXXX" />
        <label>Dosya</label><input id="fileInput" type="file" />
        <label>BaÅŸlÄ±k (opsiyonel)</label><input id="caption" placeholder="AÃ§Ä±klama" />
        <button id="sendMediaBtn">GÃ¶nder</button>
        <div id="sendMediaResp" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- CanlÄ± AkÄ±ÅŸ -->
      <div class="card span-12">
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3>CanlÄ± AkÄ±ÅŸ</h3>
          <div class="row" style="gap:8px">
            <span class="muted">SSE ile yayÄ±nda</span>
            <button class="ghost" id="clearLiveBtn">Temizle</button>
          </div>
        </div>
        <div id="live" class="list" style="max-height:360px"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // --- helpers ---
    const $ = sel => document.querySelector(sel);
    const el = id => document.getElementById(id);
    const toast = (msg) => { const t=el('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); };
    const authToken = localStorage.getItem('sb_token');
    if(!authToken){ location.href = '/login.html'; }

    const AH = () => ({ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + authToken });

    const state = {
      sessions: [],
      selected: null,
      qrTimer: null,
      sse: null,
      liveMax: 200,
    };

    function pill(status){
      const s = (status||'').toLowerCase();
      if(s==='ready') return '<span class="pill ok">ready</span>';
      if(s==='pending') return '<span class="pill warn">pending</span>';
      if(s==='disconnected') return '<span class="pill bad">disconnected</span>';
      return `<span class="pill">${status||'-'}</span>`;
    }

    function setStatusPill(text, cls){
      const p = el('statusPill');
      p.className = 'pill ' + (cls||'');
      p.textContent = text;
    }

    // --- list sessions ---
    async function loadSessions(){
      setStatusPill('YÃ¼kleniyorâ€¦');
      const r = await fetch('/admin/sessions', { headers: AH() });
      const j = await r.json();
      if(!j.ok){ setStatusPill('Hata', 'bad'); return; }
      state.sessions = j.sessions || [];
      setStatusPill(`Oturum: ${state.sessions.length}`, 'ok');

      const box = el('sessionList'); box.innerHTML = '';
      state.sessions.forEach(s=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="row" style="justify-content:space-between;gap:12px">
            <div class="nowrap"><b>${s.name||s.id}</b><div class="muted mono">${s.id}</div></div>
            <div>${pill(s.status)}</div>
          </div>
          <div class="muted mono nowrap">api: ${s.api_key ? (s.api_key.slice(0,12)+'â€¦') : '-'}</div>
        `;
        div.onclick = ()=> selectSession(s.id);
        box.appendChild(div);
      });

      // seÃ§ili oturumu gÃ¼ncelle
      if(state.selected){
        const exists = state.sessions.find(x=>x.id===state.selected.id);
        if(exists) selectSession(state.selected.id, true);
      }
    }

    // --- select session ---
    function selectSession(id, keepQR){
      const s = state.sessions.find(x=>x.id===id);
      if(!s){ toast('Oturum bulunamadÄ±'); return; }
      state.selected = s;
      el('selectedNone').style.display='none';
      el('selected').style.display='block';
      el('s_id').textContent = s.id;
      el('s_name').textContent = s.name || s.id;
      el('s_status').innerHTML = pill(s.status);
      el('s_api').textContent = s.api_key || '';
      el('s_secret').textContent = s.webhook_secret || '';
      el('w_url').value = s.webhook_url || '';
      // cURL Ã¶rneÄŸini gÃ¼ncelle
      updateCurlExample();
      // form varsayÄ±lan alÄ±cÄ± kutularÄ±nÄ± doldurmak istersen:
      // el('toText').value = ''; el('toMedia').value = '';

      if(!keepQR) showQR();
    }

    function updateCurlExample(){
      const s = state.selected; if(!s){ el('s_curl').textContent = ''; return; }
      const base = (window.ENV_PUBLIC_BASE_URL && window.ENV_PUBLIC_BASE_URL.trim()) ? window.ENV_PUBLIC_BASE_URL.trim() : location.origin;
      const apiKey = s.api_key || '<api_key>';
      const exampleTo = '+90xxxxxxxxxx';
      const exampleText = 'Hello from API!';
      const curl = [
        `curl -X POST "${base}/api/send-message" \\\n -H "Authorization: Bearer ${apiKey}" \\\n -H "Content-Type: application/json" \\\n -d '{"to": "${exampleTo}", "text": "${exampleText}"}'`
      ].join('\n');
      el('s_curl').textContent = curl;
    }

    // --- QR show/refresh ---
    async function showQR(){
      clearInterval(state.qrTimer);
      el('qrBox').innerHTML = '<span class="muted">QR bekleniyorâ€¦</span>';
      await fetchQROnce();
      // periyodik yenile (ready olana kadar)
      state.qrTimer = setInterval(fetchQROnce, 3000);
    }
    async function fetchQROnce(){
      if(!state.selected) return;
      const id = state.selected.id;
      const r = await fetch(`/admin/sessions/${id}/qr`, { headers: AH() });
      const j = await r.json();
      const box = el('qrBox');
      if(!j.ok){ box.textContent = 'QR alÄ±namadÄ±'; return; }
      if(j.ready){
        clearInterval(state.qrTimer);
        box.innerHTML = '<span class="pill ok">BaÄŸlÄ± âœ”</span>';
      }else if(j.qr){
        const img = new Image(); img.src = j.qr; img.className='qr';
        box.innerHTML = ''; box.appendChild(img);
      }else{
        box.innerHTML = '<span class="muted">QR hazÄ±r deÄŸil, birazdan tekrar denenecekâ€¦</span>';
      }
    }

    // --- create session ---
    async function createSession(){
      el('createBtn').disabled = true;
      try{
        const name = el('newName').value.trim();
        const r = await fetch('/admin/sessions', { method:'POST', headers: AH(), body: JSON.stringify({ name }) });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error||'create fail');
        el('createResp').innerHTML =
          `ID: <b>${j.id}</b><br/>API_KEY: <span class="mono">${j.api_key}</span><br/>WEBHOOK_SECRET: <span class="mono">${j.webhook_secret}</span>`;
        await loadSessions();
        selectSession(j.id);
        toast('Oturum oluÅŸturuldu');
      }catch(e){ toast('Hata: '+e.message); }
      el('createBtn').disabled = false;
    }

    // --- save webhook ---
    async function saveWebhook(){
      if(!state.selected) return;
      const id = state.selected.id;
      const url = el('w_url').value.trim();
      if(!url) return toast('Webhook URL girin');
      const r = await fetch(`/admin/sessions/${id}/webhook`, { method:'POST', headers: AH(), body: JSON.stringify({ url }) });
      const t = await r.text();
      el('webhookResp').textContent = t;
      await loadSessions();
      toast('Webhook kaydedildi');
    }

    // --- ping webhook (Ã¶rnek) ---
    async function pingWebhook(){
      if(!state.selected) return;
      const s = state.selected;
      if(!s.webhook_url) return toast('Ã–nce webhook URL kaydet');
      // sadece test: doÄŸrudan webhookâ€™a minik bir payload POST eder
      try{
        const resp = await fetch(s.webhook_url, { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ sessionId:s.id, event:'ping', data:{now:Date.now()}, ts:Date.now() }) });
        toast('Webhook yanÄ±tÄ±: '+resp.status);
      }catch(e){ toast('Webhook hata: '+e.message); }
    }

    // --- send text ---
    async function sendText(){
      if(!state.selected) return toast('Oturum seÃ§in');
      const s = state.selected;
      const to = el('toText').value.trim();
      const text = el('msgText').value;
      if(!to || !text) return toast('AlÄ±cÄ± ve mesaj zorunlu');
      const r = await fetch(`/api/${s.id}/send-text`, {
        method:'POST', headers:{'Content-Type':'application/json','X-API-Key': s.api_key||''},
        body: JSON.stringify({ to, text })
      });
      const t = await r.text();
      el('sendTextResp').textContent = t;
      if(r.ok) toast('Mesaj gÃ¶nderildi');
      else toast('GÃ¶nderim hatasÄ±');
    }

    // --- send media ---
    async function sendMedia(){
      if(!state.selected) return toast('Oturum seÃ§in');
      const s = state.selected;
      const to = el('toMedia').value.trim();
      const file = el('fileInput').files[0];
      const caption = el('caption').value;
      if(!to || !file) return toast('AlÄ±cÄ± ve dosya gerekli');

      const b64 = await new Promise((res, rej)=>{
        const reader = new FileReader();
        reader.onload = () => res(reader.result); // data URI
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });

      const r = await fetch(`/api/${s.id}/send-media`, {
        method:'POST', headers:{'Content-Type':'application/json','X-API-Key': s.api_key||''},
        body: JSON.stringify({ to, caption, media:{ base64:b64, filename:file.name } })
      });
      const t = await r.text();
      el('sendMediaResp').textContent = t;
      if(r.ok) toast('Medya gÃ¶nderildi'); else toast('Medya gÃ¶nderim hatasÄ±');
    }

    // --- SSE live feed ---
    function startSSE(){
      try{
        if(state.sse) state.sse.close();
      }catch{}
      const es = new EventSource('/admin/events?token=' + encodeURIComponent(authToken));
      state.sse = es;
      es.addEventListener('message', ev => pushLive(JSON.parse(ev.data), 'msg'));
      es.addEventListener('status', ev => pushLive(JSON.parse(ev.data), 'status'));
      es.onerror = () => pushLive({ info:'SSE baÄŸlantÄ±sÄ± koptu' }, 'error');
    }

    function pushLive(data, kind){
      const live = el('live');
      const row = document.createElement('div');
      row.className = 'item';
      if(kind==='msg'){
        row.innerHTML = `<span class="mono">[${data.sessionId}]</span> ${data.from} â†’ ${data.to} : <b>${escapeHtml(data.body||'')}</b>`;
      } else if(kind==='status'){
        row.innerHTML = `<span class="mono">[${data.sessionId}]</span> durum: <b>${data.status}</b> ${data.reason?' ('+data.reason+')':''}`;
      } else {
        row.textContent = data.info || 'â€”';
      }
      live.prepend(row);
      while(live.children.length > state.liveMax){ live.removeChild(live.lastChild); }
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // --- copy buttons ---
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-copy]');
      if(!btn) return;
      const sel = btn.getAttribute('data-copy');
      const text = $(sel)?.textContent || '';
      if(!text) return;
      navigator.clipboard.writeText(text).then(()=>toast('KopyalandÄ±'));
    });

    // --- events ---
    el('refreshBtn').onclick = loadSessions;
    el('createBtn').onclick = createSession;
    el('showQRBtn').onclick = showQR;
    el('saveWebhookBtn').onclick = saveWebhook;
    el('pingWebhookBtn').onclick = pingWebhook;
    el('sendTextBtn').onclick = sendText;
    el('sendMediaBtn').onclick = sendMedia;
    el('clearLiveBtn').onclick = ()=>{ el('live').innerHTML=''; };
    el('logoutBtn').onclick = ()=>{ localStorage.removeItem('sb_token'); location.href='/login.html'; };

    // init
    startSSE();
    loadSessions();
  </script>
</body>
</html>
