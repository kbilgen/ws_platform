<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Admin Panel</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    input, textarea, button { padding: 8px; border: 1px solid #ccc; border-radius: 8px; width: 100%; margin-bottom: 10px; }
    button { background: #111; color: #fff; cursor: pointer; }
    .list { max-height: 240px; overflow: auto; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
    .item { padding: 6px; border-bottom: 1px solid #f2f2f2; cursor: pointer; }
    .item:hover { background: #fafafa; }
    img { max-width: 280px; margin-top: 12px; }
    .mono { font-family: ui-monospace, monospace; }
  </style>
</head>
<body>
  <h2>Admin Panel</h2>

  <div class="card">
    <button onclick="loadSessions()">OturumlarÄ± Listele</button>
    <div id="sessionList" class="list"></div>
  </div>

  <div class="card">
    <h3>Yeni Oturum (Session) OluÅŸtur</h3>
    <input id="sessionName" placeholder="Ä°sim (opsiyonel)">
    <button onclick="createSession()">OluÅŸtur</button>
    <div id="created"></div>
    <div id="qrBox"></div>
  </div>

  <div class="card">
    <h3>Webhook Ayarla</h3>
    <input id="sid" placeholder="Session ID">
    <input id="wurl" placeholder="Webhook URL">
    <button onclick="setWebhook()">Kaydet</button>
    <div id="wresp"></div>
  </div>

  <div class="card">
    <h3>Test: Mesaj GÃ¶nder</h3>
    <input id="sid2" placeholder="Session ID">
    <input id="key2" placeholder="API Key">
    <input id="to2" placeholder="905xxxxxxxxx">
    <textarea id="text2">Selam ðŸ‘‹</textarea>
    <button onclick="sendText()">GÃ¶nder</button>
    <div id="tresp"></div>
  </div>

<script>
const ah = () => ({ 'X-Admin-Auth': localStorage.getItem('adminAuth') });

async function loadSessions(){
  const r = await fetch('/admin/sessions', { headers: ah() });
  const j = await r.json();
  const box = document.getElementById('sessionList'); box.innerHTML='';
  if(!j.ok) return box.textContent = 'Hata: ' + (j.error||'');
  j.sessions.forEach(s=>{
    const d = document.createElement('div'); d.className='item';
    d.textContent = `${s.id} | ${s.name} | ${s.status}`;
    d.onclick = ()=>{ sid.value=s.id; sid2.value=s.id; key2.value=s.api_key||''; showQR(s.id); };
    box.appendChild(d);
  });
}

async function createSession(){
  const name = document.getElementById('sessionName').value;
  const r = await fetch('/admin/sessions',{method:'POST',headers:{'Content-Type':'application/json',...ah()},
    body: JSON.stringify({ name })});
  const j = await r.json();
  if(!j.ok) return created.textContent='Hata: '+(j.error||'');
  created.innerHTML = `ID: <b>${j.id}</b><br>API_KEY: <span class="mono">${j.api_key}</span><br>WEBHOOK_SECRET: <span class="mono">${j.webhook_secret}</span>`;
  sid.value=j.id; sid2.value=j.id; key2.value=j.api_key;
  showQR(j.id);
}

async function showQR(id){
  qrBox.innerHTML = 'QR bekleniyorâ€¦';
  const r = await fetch(`/admin/sessions/${id}/qr`, { headers: ah() });
  const j = await r.json();
  if(!j.ok) return qrBox.textContent='Hata: '+(j.error||'');
  if(j.ready) return qrBox.innerHTML='<b>BaÄŸlÄ± âœ”</b>';
  if(!j.qr) return qrBox.textContent='QR henÃ¼z hazÄ±r deÄŸil.';
  const img = new Image(); img.src = j.qr; qrBox.innerHTML=''; qrBox.appendChild(img);
}

async function setWebhook(){
  const r = await fetch(`/admin/sessions/${sid.value}/webhook`, {
    method:'POST',headers:{'Content-Type':'application/json',...ah()},
    body: JSON.stringify({ url: wurl.value })
  });
  wresp.textContent = await r.text();
}

async function sendText(){
  const r = await fetch(`/api/${sid2.value}/send-text`, {method:'POST',
    headers:{'Content-Type':'application/json','X-API-Key': key2.value},
    body: JSON.stringify({ to: to2.value, text: text2.value })});
  tresp.textContent = await r.text();
}
</script>
</body>
</html>
