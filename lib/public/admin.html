<!doctype html><meta charset="utf-8">
<title>Admin</title>
<style>
body{font-family:system-ui;margin:24px}
.card{border:1px solid #eee;border-radius:12px;padding:16px;margin-bottom:16px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.half{flex:1 1 360px}
img{max-width:280px;border:1px solid #ddd;border-radius:8px}
input,button,textarea{padding:10px;border:1px solid #ccc;border-radius:8px;width:100%}
button{background:#111;color:#fff;cursor:pointer}
.list{max-height:260px;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px}
.item{padding:6px;border-bottom:1px solid #f2f2f2;cursor:pointer}
.item:hover{background:#fafafa}
.mono{font-family:ui-monospace,Menlo,monospace}
</style>

<h2>Admin Panel</h2>
<div class="card">
  <button onclick="load()">Yenile</button>
  <div id="list" class="list"></div>
</div>

<div class="row">
  <div class="card half">
    <h3>Yeni Hat (Session) OluÅŸtur & QR</h3>
    <label>Ä°sim</label>
    <input id="name" placeholder="Ã–rn: Klinik HattÄ±">
    <button onclick="create()">OluÅŸtur</button>
    <div id="created" class="mono"></div>
    <div id="qrBox"></div>
  </div>
  <div class="card half">
    <h3>Webhook Ayarla</h3>
    <label>Session ID</label><input id="sid">
    <label>Webhook URL</label><input id="wurl" placeholder="https://...">
    <button onclick="setWebhook()">Kaydet</button>
    <div id="wresp"></div>
  </div>
</div>

<div class="row">
  <div class="card half">
    <h3>Test: Metin GÃ¶nder</h3>
    <label>Session ID</label><input id="sid2">
    <label>API Key</label><input id="key2">
    <label>AlÄ±cÄ±</label><input id="to2" placeholder="905xxxxxxxxx">
    <label>Mesaj</label><textarea id="text2" rows="3">Selam ðŸ‘‹</textarea>
    <button onclick="sendText()">GÃ¶nder</button>
    <div id="tresp"></div>
  </div>
</div>

<script>
const ah = () => ({ 'X-Admin-Auth': localStorage.getItem('adminAuth') });

async function load(){
  const r = await fetch('/admin/sessions', { headers: ah() });
  const j = await r.json();
  const box = document.getElementById('list'); box.innerHTML='';
  if(!j.ok) return box.textContent = 'Hata: ' + (j.error||'');
  j.sessions.forEach(s=>{
    const d = document.createElement('div'); d.className='item';
    d.textContent = `${s.id} | ${s.name} | ${s.status} | apiKey: ${s.api_key ? s.api_key.slice(0,8)+'â€¦' : '-'}`;
    d.onclick = ()=>{ sid.value=s.id; sid2.value=s.id; key2.value=s.api_key||''; showQR(s.id); };
    box.appendChild(d);
  });
}

async function create(){
  const r = await fetch('/admin/sessions',{method:'POST',headers:{'Content-Type':'application/json',...ah()},
    body: JSON.stringify({ name: name.value })});
  const j = await r.json();
  if(!j.ok) return created.textContent='Hata: '+(j.error||'');
  created.innerHTML = `ID: <b>${j.id}</b><br>API_KEY: <b class="mono">${j.api_key}</b><br>WEBHOOK_SECRET: <b class="mono">${j.webhook_secret}</b>`;
  sid.value = j.id; sid2.value=j.id; key2.value=j.api_key;
  showQR(j.id);
}

async function showQR(id){
  qrBox.innerHTML = 'QR bekleniyorâ€¦';
  const r = await fetch(`/admin/sessions/${id}/qr`, { headers: ah() });
  const j = await r.json();
  if(!j.ok) return qrBox.textContent='Hata: '+(j.error||'');
  if(j.ready) return qrBox.innerHTML = '<b>BaÄŸlÄ± âœ”</b>';
  if(!j.qr) { qrBox.textContent='QR hazÄ±r deÄŸil, 2-3 sn sonra tekrar yenileyin'; return; }
  const img = new Image(); img.src = j.qr; qrBox.innerHTML=''; qrBox.appendChild(img);
}

async function setWebhook(){
  const r = await fetch(`/admin/sessions/${sid.value}/webhook`, {method:'POST',headers:{'Content-Type':'application/json',...ah()},
    body: JSON.stringify({ url: wurl.value })});
  wresp.textContent = await r.text();
}

async function sendText(){
  const r = await fetch(`/api/${sid2.value}/send-text`, {method:'POST',
    headers:{'Content-Type':'application/json','X-API-Key': key2.value},
    body: JSON.stringify({ to: to2.value, text: text2.value })});
  tresp.textContent = await r.text();
}

load();
</script>
